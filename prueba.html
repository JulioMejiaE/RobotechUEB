<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ROBOTECH - Chat</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="container">
        <!-- Panel lateral -->
        <aside class="sidebar">
            <div class="logo">
                <img src="/img/robot.png" alt="Logo" />
            </div>

            <h1>ROBOTECH</h1>
            <p class="subtitulo">Tu asistente inteligente de neuroanatom√≠a y anatom√≠a humana</p>

            <div class="documentos">
                <h3>Documentos cargados</h3>
                <div class="lista-documentos" id="listaDocs">
                    <p>No hay documentos cargados</p>
                </div>
                <button id="btnLimpiarDocs" class="btn-enviar" style="margin-top:10px;">üóëÔ∏è Limpiar documentos</button>
            </div>
        </aside>

        <!-- √Årea de chat -->
        <main class="chat-section">
            <header class="chat-header">
                <h2>CHAT BOT</h2>
                <button class="logout-btn" id="btnLogout">Cerrar sesi√≥n</button>
            </header>

            <!-- Contenedor del chat -->
            <div id="chat"></div>

            <!-- Formulario -->
            <form id="chatForm">
                <div class="input-container">
                    <input type="text" id="pregunta" name="pregunta" placeholder="Escrib√≠ tu pregunta..." required />
                    <button type="submit" class="btn-enviar">ENVIAR</button>
                </div>

                <div class="pdf-container">
                    <label for="file" class="btn-pdf">
                        üìÑ
                        <input type="file" id="file" name="data" accept="application/pdf" hidden />
                    </label>
                    <button type="button" id="btnSubirPDF" class="btn-enviar">SUBIR PDF</button>
                </div>
            </form>
        </main>
    </div>

    <script>
        // üü° VALIDACI√ìN DE SESI√ìN
        const usuario = JSON.parse(localStorage.getItem('usuario'));
        if (!usuario || !usuario.email) {
            window.location.href = 'index.html';
        }

        // üî¥ Bot√≥n Cerrar Sesi√≥n
        document.getElementById('btnLogout').addEventListener('click', () => {
            localStorage.removeItem('usuario');
            localStorage.removeItem('documentos');
            localStorage.removeItem('documento_activo');
            window.location.href = 'index.html';
        });

        // üìÑ VARIABLES
        const chat = document.getElementById('chat');
        const listaDocs = document.getElementById('listaDocs');
        const fileInput = document.getElementById('file');
        const preguntaInput = document.getElementById('pregunta');

        // üß† Webhooks de n8n
        const WEBHOOK_PDF = "https://julioescudero.app.n8n.cloud/webhook/528a2e2e-0c59-4b3b-9125-60a82a8322f5";       // Guardar PDF
        const WEBHOOK_PREGUNTA = "https://julioescudero.app.n8n.cloud/webhook/0b915cad-e5c9-4f12-8e74-c6825419f23a  "; // Preguntar IA
        const WEBHOOK_LISTAR = "https://julioescudero.app.n8n.cloud/webhook/listar-pdfs"; // Listar documentos (nuevo flujo n8n)

        let documentos = JSON.parse(localStorage.getItem('documentos')) || [];
        let documentoActivo = localStorage.getItem('documento_activo') || null;

        // üü¢ Cargar lista de documentos
        function actualizarLista() {
            if (documentos.length === 0) {
                listaDocs.innerHTML = `<p>No hay documentos cargados</p>`;
                return;
            }

            listaDocs.innerHTML = documentos.map(doc => `
        <div class="doc-item ${doc.id == documentoActivo ? 'activo' : ''}" data-id="${doc.id}">
          üìÑ ${doc.name}
        </div>
      `).join('');

            document.querySelectorAll('.doc-item').forEach(item => {
                item.addEventListener('click', () => {
                    documentoActivo = item.dataset.id;
                    localStorage.setItem('documento_activo', documentoActivo);
                    actualizarLista();
                    chat.innerHTML += `<div class="mensaje bot">üìö Has seleccionado el documento: ${item.textContent}</div>`;
                });
            });
        }

        // üîÑ Cargar documentos del usuario desde n8n al iniciar
        async function cargarDocumentosGuardados() {
            try {
                const res = await fetch(WEBHOOK_LISTAR, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: usuario.email })
                });
                const docs = await res.json();
                const documentos = [docs].map((d, i) => ({
                    id: d.id || i,
                    name: d.nombre || d.name || 'Documento',
                }));

                localStorage.setItem('documentos', JSON.stringify(documentos));
                actualizarLista();
            } catch (error) {
                console.error('Error al recuperar documentos:', error);
            }
        }

       document.addEventListener('DOMContentLoaded', cargarDocumentosGuardados);

        // üü° Subir PDF
        document.getElementById('btnSubirPDF').addEventListener('click', async () => {
            if (!fileInput.files[0]) return alert('Selecciona un PDF primero.');

            const formData = new FormData();
            formData.append('data', fileInput.files[0]);
            formData.append('email', usuario.email);

            chat.innerHTML += `<div class="mensaje bot">üì§ Subiendo PDF...</div>`;
            chat.scrollTop = chat.scrollHeight;

            try {
                const resPDF = await fetch(WEBHOOK_PDF, { method: 'POST', body: formData });
                const data = await resPDF.json();

                if (data && data.id) {
                    const docId = data.id;
                    const docName = fileInput.files[0].name;

                    documentos.push({ id: docId, name: docName });
                    localStorage.setItem('documentos', JSON.stringify(documentos));
                    documentoActivo = docId;
                    localStorage.setItem('documento_activo', documentoActivo);

                    chat.innerHTML += `<div class="mensaje bot">‚úÖ PDF "${docName}" guardado correctamente.</div>`;
                    actualizarLista();
                } else {
                    chat.innerHTML += `<div class="mensaje bot">‚ö†Ô∏è PDF subido, pero no se recibi√≥ el ID.</div>`;
                }
            } catch (error) {
                chat.innerHTML += `<div class="mensaje bot">‚ö†Ô∏è Error al subir PDF</div>`;
                console.error(error);
            }
        });

        // üí¨ Enviar pregunta
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pregunta = preguntaInput.value.trim();

            if (!pregunta) return alert('Escribe una pregunta');
            if (!documentoActivo) {
                chat.innerHTML += `<div class="mensaje bot">‚ö†Ô∏è Primero selecciona o sub√≠ un PDF.</div>`;
                return;
            }

            chat.innerHTML += `<div class="mensaje usuario">${pregunta}</div>`;
            chat.scrollTop = chat.scrollHeight;

            try {
                const resPregunta = await fetch(WEBHOOK_PREGUNTA, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pregunta, document_id: documentoActivo })
                });

                const respuestaIA = await resPregunta.text();
                chat.innerHTML += `<div class="mensaje bot">ü§ñ ${respuestaIA}</div>`;
                chat.scrollTop = chat.scrollHeight;
                preguntaInput.value = '';
            } catch (error) {
                chat.innerHTML += `<div class="mensaje bot">‚ö†Ô∏è Error al enviar la pregunta</div>`;
                console.error(error);
            }
        });

        // üßπ Limpiar documentos
        document.getElementById('btnLimpiarDocs').addEventListener('click', () => {
            if (confirm('¬øSeguro que quieres eliminar todos los documentos guardados?')) {
                localStorage.removeItem('documentos');
                localStorage.removeItem('documento_activo');
                documentos = [];
                documentoActivo = null;
                actualizarLista();
                chat.innerHTML += `<div class="mensaje bot">üßπ Se limpiaron todos los documentos.</div>`;
            }
        });
    </script>
</body>

</html>